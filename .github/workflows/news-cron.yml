name: News jobs (refresh)

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

jobs:
  refresh:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Show tool versions
        run: |
          node -v
          npm -v

      - name: Refresh news pipeline
        env:
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
          NEWS_BASE_URL: ${{ secrets.NEWS_BASE_URL }}
        run: |
          BASE="${NEWS_BASE_URL:-https://platforma-edukacyjna-feature-news-s.vercel.app}"
          echo "Pinging: $BASE/api/jobs/news/refresh"
          curl -sS -i --fail-with-body -L \
            --max-time 180 --connect-timeout 15 \
            --retry 3 --retry-delay 3 --retry-connrefused --retry-all-errors \
            -H "x-cron-secret: ${CRON_SECRET}" \
            "$BASE/api/jobs/news/refresh" \
            -w "\nHTTP_STATUS:%{http_code}\n"
