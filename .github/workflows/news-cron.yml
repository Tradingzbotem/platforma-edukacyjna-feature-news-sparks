name: News jobs (refresh)

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

jobs:
  refresh:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Refresh news pipeline
        env:
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
          NEWS_BASE_URL: ${{ secrets.NEWS_BASE_URL }}
        run: |
          BASE="${NEWS_BASE_URL:-https://platforma-edukacyjna-feature-news-s.vercel.app}"
          URL="$BASE/api/jobs/news/refresh"

          echo "Pinging: $URL"
          echo "CRON_SECRET set? $([ -n "$CRON_SECRET" ] && echo yes || echo no)"

          curl -sS -i --fail-with-body -L \
            --max-time 180 --connect-timeout 15 \
            --retry 3 --retry-delay 3 --retry-connrefused --retry-all-errors \
            -X POST \
            -H "x-cron-secret: ${CRON_SECRET}" \
            -H "Content-Type: application/json" \
            --data '{}' \
            "$URL" \
            -w "\nHTTP_STATUS:%{http_code}\n"
