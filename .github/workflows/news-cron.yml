name: News jobs (ping)

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

jobs:
  ping:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Show tool versions
        run: |
          node -v
          npm -v

      - name: Ping ingest
        env:
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
        run: |
          echo "Pinging: /api/jobs/news/ingest"
          curl -sS -i --fail-with-body \
            --max-time 60 --connect-timeout 10 \
            --retry 2 --retry-delay 2 --retry-connrefused \
            -H "x-cron-secret: ${CRON_SECRET}" \
            "https://platforma-edukacyjna-feature-news-s.vercel.app/api/jobs/news/ingest" \
            -w "\nHTTP_STATUS:%{http_code}\n"

      - name: Ping enrich
        env:
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
        run: |
          echo "Pinging: /api/jobs/news/enrich"
          curl -sS -i --fail-with-body \
            --max-time 90 --connect-timeout 10 \
            --retry 2 --retry-delay 2 --retry-connrefused \
            -H "x-cron-secret: ${CRON_SECRET}" \
            "https://platforma-edukacyjna-feature-news-s.vercel.app/api/jobs/news/enrich" \
            -w "\nHTTP_STATUS:%{http_code}\n"
